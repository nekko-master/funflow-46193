<div class="plan-page">

  <!-- ===== プランヘッダー ===== -->
  <header class="plan-header">
    <h1 class="plan-title">
      <% if @plan.date.present? %>
        <%= @plan.date.strftime("%-m月%-d日") %>
      <% end %>
      <span class="plan-park">ディズニーシーのプラン</span>
    </h1>

    <% if @plan.persisted? %>
      <p class="plan-meta">
        作成者：<%= @plan.user.nickname %> さん
      </p>
    <% else %>
      <p class="plan-meta is-preview">
        ※ これは保存前のプレビューです
      </p>
    <% end %>
  </header>

  <!-- ===== 次のアクション（最重要） ===== -->
  <% if @plan.persisted? %>
    <section class="plan-primary-action">
      <%= link_to "おすすめの流れを作る",
          new_diagnosis_path(plan_id: @plan.id),
          class: "primary-button" %>

      <p class="action-note">
        いくつか質問に答えるだけで、行動の流れを提案します
      </p>
    </section>
  <% end %>

  <!-- ===== 行動ステップ ===== -->
  <section class="plan-steps-section">
    <h2 class="section-title">この日の流れ</h2>

    <% if @plan.plan_steps.any? %>
      <ol class="plan-steps">
        <% @plan.plan_steps.sort_by(&:step_number).each do |step| %>
          <li class="plan-step">
            <div class="step-main">
              <span class="step-number"><%= step.step_number %></span>

              <div class="step-content">
                <p class="step-title">
                  <%= step.action_type.name %> ／ <%= step.target.name %>
                </p>

                <% if step.time.present? || step.note.present? %>
                  <p class="step-meta">
                    <% if step.time.present? %>
                      <span class="step-time">
                        <%= step.time.strftime("%H:%M") %>
                      </span>
                    <% end %>

                    <% if step.note.present? %>
                      <span class="step-note">
                        <%= step.note %>
                      </span>
                    <% end %>
                  </p>
                <% end %>
              </div>
            </div>

            <% if @plan.persisted? %>
              <div class="step-actions">
                <%= link_to "編集",
                    edit_plan_plan_step_path(step.plan, step),
                    class: "tertiary-button" %>

                <%= link_to "削除",
                    plan_plan_step_path(step.plan, step),
                    data: {
                      turbo_method: :delete,
                      turbo_confirm: "削除しますか？"
                    },
                    class: "tertiary-button is-danger" %>
              </div>
            <% end %>
          </li>
        <% end %>
      </ol>

    <% else %>
      <div class="empty-steps">
        <p class="empty-title">
          まだ流れが決まっていません
        </p>
        <p class="empty-text">
          <% if @plan.persisted? %>
            おすすめ診断を使うか、手動で行動を追加できます
          <% else %>
            この内容で保存するか、診断をやり直してください
          <% end %>
        </p>
      </div>
    <% end %>
  </section>

  <!-- ===== 補助アクション ===== -->
  <section class="plan-secondary-actions">
    <% if @plan.persisted? %>
      <%= link_to "手動で行動を追加",
          new_plan_plan_step_path(@plan),
          class: "secondary-button" %>

      <%= link_to "プランを編集",
          edit_plan_path(@plan),
          class: "tertiary-button" %>

      <%= link_to "プランを削除",
          plan_path(@plan),
          data: {
            turbo_method: :delete,
            turbo_confirm: "本当に削除しますか？"
          },
          class: "tertiary-button is-danger" %>
    <% else %>
      <%= button_to "この内容で保存する",
          plans_path,
          method: :post,
          class: "primary-button" %>

      <%= link_to "診断をやり直す",
          new_diagnosis_path,
          class: "tertiary-button" %>
    <% end %>
  </section>

  <!-- ===== ナビゲーション ===== -->
  <% if @plan.persisted? %>
    <nav class="plan-footer-nav">
      <%= link_to "プラン一覧に戻る",
          plans_path,
          class: "tertiary-button" %>
    </nav>
  <% end %>

</div>
